\documentclass[fleqn]{jreport}
\input{preamble}

\begin{document}
\chapter{位相相関の手法の拡張}
OjansivuらによるBIPC（Blur-Invariant Phase Correlation）という手法ではフーリエ変換の畳み込みの性質を用いて，
モーションブラーによる画像変位の影響を取り除く手法が紹介されている。


画像$a$にブラーとノイズがかかった場合の画像を$b$とすると以下の数式に示す対応関係が生じる。
\begin{align}
b(n_1,n_2) = a(n_1,n_2) * h(n_1,n_2) + n(n_1,n_2)
\end{align}
ここで$h(n_1,n_2)$は畳み込まれるブラー成分であり$n(n_1,n_2)$はノイズ成分である。
ノイズが十分小さいとしてこれを2次元フーリエ変換すると畳込みとフーリエ変換の性質より，畳込みは周波数領域での乗算で次のように表される。
\begin{align}
B(k_1,k_2) = A(k_1,k_2) \dot  H(k_1,k_2)
\end{align}
ここで，$B$を振幅で正規化した位相成分に着目すると，
\begin{align}
\frac{B(k_1,k_2)}{|B(k_1,k_2)|} = \exp{-i\phi_b(k_1,k_2)}= \exp{-i(\phi_a(k_1,k_2) +\phi_h(k_1,k_2))}
\end{align}
のように表すことができる。


ところで，ブラーの変形量は中心対称とすると，$\phi_h(k_1,k_2)$の値は$0$か$\pi$に限定される。
この仮定のもと，自然数$n$を用いた位相成分の$2n$乗を考えると，
\begin{align}
\left( \frac{B(k_1,k_2)}{|B(k_1,k_2)|} \right)^{2n} =  \exp{-i(2n\phi_a(k_1,k_2) +2n\phi_h(k_1,k_2))} = \exp{-i (2n\phi_a(k_1,k_2))}
\end{align}
の様に書けるためブラーの成分の影響を無視することができることがわかる。

従って画像入力$f$と$g$に対して新たにPhaseCorrelation関数$S(k_1,k_2)$を
\begin{align}
S(k_1,k_2) &= \left( \frac{F(k_1,k_2)\bar{G(k_1,k_2)}}{|F(k_1,k_2)||G(k_1,k_2)|} \right)^{2n}
\end{align}
と置くことで，これをフーリエ逆変換した$s(n_1,n_2)$は次のように表せる。
\begin{align}
s(n_1,n_2) = \delta(n_1-2nx,n_2-2ny)
\end{align}
ここで，$f$と$g$の間の平行移動量を$(x,y)$と置いており，$\delta$はディラックのデルタ関数である。
一般には$n=1$とするのが望ましい。

この手法を用いることで有効に画像の変異を抽出できる範囲が半分になることに留意する必要がある。

\chapter{特徴点座標群が与えられた場合のAffineまたはhomography変換行列の推定手法}

\section{変換行列の定義}
変換前の画像の座標群を$(x^*_i,y^*_i)^T$，変換後の座標群を$(x_i,y_i)^T$と定義$(i=1,2,3...)$する。
ここで，Affine変換は一般に以下のように定義される。
\begin{align}
\begin{pmatrix}
x_i \\ 
y_i
\end{pmatrix} =\begin{pmatrix}
a_1 & a_3 & a_5 \\ 
a_2 & a_4 & a_6
\end{pmatrix} \begin{pmatrix}
x_i^* \\ 
y_i^* \\ 
1
\end{pmatrix}  \label{eq:Affine変換行列}
\end{align}
$a_{i} \ (i=1,2,3,4,5,6)$で表される行列はAffine変換行列と呼ばれ，$a_{1}~a_{4}$は回転と各軸方向における拡大縮小を表し，$a_5,a_6$は平行移動量を表す。
同様にして，Homography変換も以下のような形で書ける。
\begin{align}
\begin{pmatrix}
x_i \\ 
y_i \\
1
\end{pmatrix} =\begin{pmatrix}
g_1 & g_4 & g_7 \\ 
g_2 & g_5 & g_8 \\ 
g_3 & g_6 & g_9
\end{pmatrix}  \begin{pmatrix}
x_i^* \\ 
y_i^* \\ 
1
\end{pmatrix}  
\end{align}
$g_1~g_9$で表される行列はHomography変換行列と呼ばれ，一般には$g_9=1$としてスケールをあわせる場合が多い。その場合，適切なスケーリングファクター$s$を用いて次のように表されることが多い。
\begin{align}
\begin{pmatrix}
x_i \\ 
y_i \\
1
\end{pmatrix} =s \begin{pmatrix}
g_1 & g_4 & g_7 \\ 
g_2 & g_5 & g_8 \\ 
g_3 & g_6 & 1
\end{pmatrix}  \begin{pmatrix}
x_i^* \\ 
y_i^* \\ 
1
\end{pmatrix}  \\
\mbox{while,}
s=\frac{1}{g_{3}x^*_i+g_{6}y^*_i+1}
\label{eq:Gscale}
\end{align}
$g_3=g_6=0$とおいた場合，これはAffine変換行列と同義になる。Homography行列を用いることによってAffine変換で扱われる回転と平行移動，軸方向への拡大縮小の他に，任意の2次元画像上の変換を記述することができる。


\section{変換行列の同定法}
\subsection{Affine行列の推定}
Affine行列を推定する際は一般に線形解法が用いられる。
1組の対応点を取得することにより\shiki{AffineEquation}2つの方程式を得ることができるため\shiki{Affine変換行列}に示すAffine行列の全パラメータを求めるためには最低でも3つの対応点を探す必要がある。
\begin{align}
\left(
\begin{array}{c}
x_i\\
y_i
\end{array}
\right)=\left(
\begin{array}{ccc}
\vspace{2mm}
a_{1}x^*_i+a_{3}y^*_i+a_{5} \\ 
a_{2}x^*_i+a_{4}y^*_i+a_{6}
\end{array}
\right) \label{eq:AffineEquation}
\end{align}
また，この\shiki{AffineEquation}を行列の各成分を要素に持つベクトル対する係数行列の形に書き直すと，次のようになる。
\begin{align}
\begin{pmatrix}
x^*_i & 0 & y^*_i & 0 & 1 & 0 \\ 
0 & x^*_i & 0 & y^*_i & 0 & 1
\end{pmatrix} \begin{pmatrix}
a_1 \\ 
a_2 \\ 
a_3 \\ 
a_4 \\ 
a_5 \\ 
a_6
\end{pmatrix} = \begin{pmatrix}
x_i \\ 
y_i
\end{pmatrix} \label{eq:affineEq2}
\end{align}
したがってこれを対応付けた$n (n \geq 3) $個の点について行列を縦に並べることで，線形方程式の形にすることができる。
\begin{align}
&\bm{Ax}=\bm{b}\label{eq:affineLinear}  \\
&\bm{A} = \begin{pmatrix}
x^*_1 & 0 & y^*_1 & 0 & 1 & 0 \\ 
0 & x^*_1 & 0 & y^*_1 & 0 & 1 \\
& & \vdots &   &\\
& & \vdots &   &\\
x^*_n & 0 & y^*_n & 0 & 1 & 0 \\ 
0 & x^*_n & 0 & y^*_n & 0 & 1
\end{pmatrix} , \hspace{2mm}
\bm{x} = \begin{pmatrix}
a_1 \\ 
a_2 \\ 
a_3 \\ 
a_4 \\ 
a_5 \\ 
a_6
\end{pmatrix} , \hspace{2mm}
\bm{b}= \begin{pmatrix}
x_1 \\ 
y_1 \\
\vdots \\
\vdots \\
x_n \\ 
y_n
\end{pmatrix} \nonumber 
\end{align}
\shiki{affineLinear}は$\bm{A}$の擬似逆行列$\bm{A}^+$を計算することで，最小二乗解を次のように求めることができる。
\begin{align}
\bm{x} = \bm{A}^+\bm{b}
\end{align}

\subsection{Homography行列の推定}
ここではHomography行列の線形解法について述べる。
Homography行列の場合，対応する点1つにつき次のような関係式があるため，計4つの特徴点を用いることでHomographyを計算できる。
\begin{align}
\left(
\begin{array}{c}
x_i\\
y_i 
\end{array}
\right)=\left(
\begin{array}{ccc}
\vspace{2mm}
\dfrac{g_{1}x^*_i+g_{4}y^*_i+g_{7}}{g_{3}x^*_i+g_{6}y^*_i+1} \\ \vspace{2mm}
\dfrac{g_{2}x^*_i+g_{5}y^*_i+g_{8}}{g_{3}x^*_i+g_{6}y^*_i+1} 
\end{array}
\right)\label{eq:HEquation}
\end{align}
\shiki{HEquation}を展開して，\shiki{affineEq2}と同様に行列の要素のベクトル表示に展開すると，次のようになる。
\begin{align}
\begin{pmatrix}
x^*_i & 0 & -x^*_i x_i & y^*_i & 0 & -y^*_i x_i& 1 & 0  \\ 
0 & x^*_i & -x^*_i y_i & 0 & y^*_i & -y^*_i y_i& 0 & 1
\end{pmatrix} \begin{pmatrix}
g_1 \\ 
g_2 \\ 
g_3 \\ 
g_4 \\ 
g_5 \\ 
g_6 \\
g_7 \\
g_8
\end{pmatrix} = \bm{0} \label{eq:HEq2}
\end{align}
この式は\shiki{HLinear}の行列$A$の零ベクトル，近似的には最小特異値に対応するベクトルを求める問題に帰結する。
\begin{align}
&\bm{Ax}=\bm{0}\label{eq:HLinear} \\
&\bm{A}=\begin{pmatrix}
x^*_1 & 0 & -x^*_1 x_1 & y^*_1 & 0 & -y^*_1 x_1& 1 & 0  \\ 
0 & x^*_1 & -x^*_1 y_1 & 0 & y^*_1 & -y^*_1 y_1& 0 & 1 \\
& & & & \vdots & & &\\
& & & & \vdots & & &\\
x^*_n & 0 & -x^*_n x_n & y^*_n & 0 & -y^*_n x_n& 1 & 0  \\ 
0 & x^*_n & -x^*_n y_n & 0 & y^*_n & -y^*_n y_n& 0 & 1
\end{pmatrix},\hspace{5mm}
\bm{x} = \begin{pmatrix}
g_1 \\ 
g_2 \\ 
g_3 \\ 
g_4 \\ 
g_5 \\ 
g_6 \\
g_7 \\
g_8
\end{pmatrix} \nonumber
\end{align}
MATLAB上では固有値分解を行った際の最小固有ベクトルを元に$\bm{x}$を推定する。

\section{RANSACを用いた外れ値の回避}
上記の複数の点を用いた変換パラメータ推定法は外れ値などに大きく影響を受けるため，繰り返し動作によって外れ値を回避する手法が提案されている。
概要は以下の通りである。
\begin{enumerate}
\item 総データ個数がU個あるデータから、ランダムでn個のデータを取り出し，取り出したn個のデータから、パラメータを求める。
\item 求めたパラメータを総データ点数から取り出したn個のデータを除いたものに対してそれぞれ当てはめて誤差を計算し誤差が許容範囲内であれば，パラメータに対して投票を行う。これを残りの全てのデータに対して行う。
\item 手順1と2を何度か繰り返して投票数が一番多かったパラメータをひとまず採用する。
採用したパラメータを使ってすべてのデータに再度式を適用し，誤差が許容範囲内のものを抽出を行う。
\item 抽出したデータを元に，手順1,2を繰り返して再度パラメータ求め直す。
\item パラメータを用いた際の誤差がある範囲に収まったならばそのパラメータを推定値とする。
\end{enumerate}


\end{document}
